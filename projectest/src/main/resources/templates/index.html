<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Budget Search</title>
    <style>
        .container, #new-window {
            display: none;
        }
        #results-container div {
            margin: 10px 0;
        }
    </style>
</head>
<body>
<div class="container" style="display: block;">
    <label for="combo-box">Select Option:</label>
    <select id="combo-box"></select>
    <br><br>
    <label for="search-field">Search:</label>
    <input type="text" id="search-field">
    <br><br>
    <label for="budget-input">Budget:</label>
    <input type="text" id="budget-input">
    <br><br>
    <button id="go-button">Go</button>
</div>

<div id="new-window">
    <button id="back-button">Back</button>
    <div id="results-container"></div>
</div>

<script>
    const baseUrl = 'http://localhost:8080'; // Replace with your server's URL

    let selected = '';
    let monIn = 0;
    let op = [];
    let coll = [];
    let maha = [];

    document.addEventListener('DOMContentLoaded', () => {
        fetchOptions();
        fetchMahas();
        fetchColleges();
    });

    async function fetchOptions() {
        const response = await fetch(`${baseUrl}/options`);
        op = await response.json();
        initComboBox();
    }

    async function fetchMahas() {
        const response = await fetch(`${baseUrl}/mahas`);
        maha = await response.json();
    }

    async function fetchColleges() {
        const response = await fetch(`${baseUrl}/colleges`);
        coll = await response.json();
    }

    function initComboBox() {
        const comboBox = document.getElementById('combo-box');
        const searchField = document.getElementById('search-field');
        const goButton = document.getElementById('go-button');
        const newWindow = document.getElementById('new-window');
        const backButton = document.getElementById('back-button');
        const resultsContainer = document.getElementById('results-container');
        const budgetInput = document.getElementById('budget-input');

        op.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option;
            opt.textContent = option;
            comboBox.appendChild(opt);
        });

        comboBox.addEventListener('change', (e) => {
            selected = e.target.value;
        });

        searchField.addEventListener('input', () => {
            const filter = searchField.value.toLowerCase();
            comboBox.innerHTML = '';
            const filteredOptions = op.filter(option => option.toLowerCase().includes(filter));
            filteredOptions.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                comboBox.appendChild(opt);
            });
            selected = filteredOptions.length > 0 ? filteredOptions[0] : "เลือกคณะ";
        });

        goButton.addEventListener('click', () => {
            try {
                const enteredText = budgetInput.value.replace(/,/g, '');
                monIn = parseFloat(enteredText);
                if (isNaN(monIn)) {
                    throw new Error('Invalid budget input');
                }
            } catch (error) {
                console.error('Error parsing budget input:', error);
                monIn = Number.MAX_VALUE;
            }
            console.log(selected);
            openNewWindow();
        });

        backButton.addEventListener('click', () => {
            newWindow.style.display = 'none';
            document.querySelector('.container').style.display = 'block';
        });

        function openNewWindow() {
            resultsContainer.innerHTML = '';
            let results = [];

            if (selected && selected !== op[0]) {
                for (let i = 0; i < 11; i++) {
                    const key = selected;
                    console.log('Checking coll[' + i + ']:', coll[i]);
                    if (coll[i][key] !== undefined && coll[i][key] !== -1 && coll[i][key] <= monIn) {
                        results.push(`${maha[i]} ${key} ${coll[i][key]} บาท`);
                    }
                }
            } else {
                for (let i = 0; i < coll.length; i++) {
                    for (let subKey in coll[i]) {
                        if (coll[i][subKey] !== undefined && coll[i][subKey] !== -1 && coll[i][subKey] <= monIn) {
                            results.push(`${maha[i]} ${subKey} ${coll[i][subKey]} บาท`);
                        }
                    }
                }
            }

            if (results.length === 0) {
                results.push('ไม่มีข้อมูลที่ตรงตามเงื่อนไข');
            }

            results.forEach(result => {
                const resultElement = document.createElement('div');
                resultElement.textContent = result;
                resultsContainer.appendChild(resultElement);
            });

            newWindow.style.display = 'block';
            document.querySelector('.container').style.display = 'none';
        }
    }
</script>
</body>
</html>
